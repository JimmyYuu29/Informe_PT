# Wordæ¨¡æ¿ä¿®æ”¹æ–¹æ¡ˆ (æ›´æ–°ç‰ˆ)

**åˆ†ææ—¥æœŸ**: 2026-01-02
**æ¨¡æ¿æ–‡ä»¶**: `config/template_final.docx`

---

## é—®é¢˜æ¦‚è¿°

ç»è¿‡è¯¦ç»†åˆ†æ `template_final.docx` æ¨¡æ¿æ–‡ä»¶ï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜å¯¼è‡´æ•°æ®æ— æ³•æ­£ç¡®æ’å…¥ï¼š

| é—®é¢˜ç±»å‹ | æ•°é‡ | ä¸¥é‡ç¨‹åº¦ |
|---------|------|---------|
| æ‹¼å†™é”™è¯¯ | 15å¤„ | ğŸ”´ ä¸¥é‡ |
| å¤§å°å†™ä¸åŒ¹é… | 11å¤„ | ğŸ”´ ä¸¥é‡ |
| å¾ªç¯å˜é‡å¼•ç”¨é”™è¯¯ | 3å¤„ | ğŸ”´ ä¸¥é‡ |
| ç¼ºå¤±å˜é‡ | 2å¤„ | ğŸŸ¡ ä¸­ç­‰ |

---

## ä¸€ã€æ‹¼å†™é”™è¯¯ (æœ€ä¸¥é‡é—®é¢˜)

### 1.1 `anyo_ejecicio` æ‹¼å†™é”™è¯¯ (å‡ºç° 13 æ¬¡)

**é—®é¢˜**: å˜é‡åç¼ºå°‘å­—æ¯ `r`ï¼Œå¯¼è‡´æ‰€æœ‰å¹´ä»½å­—æ®µæ— æ³•æ¸²æŸ“

| é”™è¯¯å†™æ³• | æ­£ç¡®å†™æ³• | å‡ºç°æ¬¡æ•° |
|---------|---------|---------|
| `{{ anyo_ejecicio }}` | `{{ anyo_ejercicio }}` | 13 |
| `{{ anyo_ejecicio_ant }}` | `{{ anyo_ejercicio_ant }}` | 2 |
| `{{anyo_ejecicio}}` | `{{ anyo_ejercicio }}` | è‹¥å¹² |

**å½±å“èŒƒå›´**:
- å°é¢æ ‡é¢˜
- è´¢åŠ¡æ•°æ®è¡¨æ ¼è¡¨å¤´
- å¤šå¤„æ–‡æ¡£æ­£æ–‡

**ä¿®å¤æ–¹æ³•**:
```
æŸ¥æ‰¾: anyo_ejecicio
æ›¿æ¢: anyo_ejercicio
```

---

## äºŒã€å¤§å°å†™ä¸åŒ¹é… (ä¸¥é‡é—®é¢˜)

docxtpl (Jinja2) æ˜¯**å¤§å°å†™æ•æ„Ÿ**çš„ã€‚æ¨¡æ¿ä¸­ä½¿ç”¨äº†é¦–å­—æ¯å¤§å†™æˆ–é©¼å³°å‘½åï¼Œä½†ç³»ç»Ÿç”Ÿæˆçš„ä¸Šä¸‹æ–‡ä½¿ç”¨å…¨å°å†™ã€‚

### 2.1 è”ç³»äººä¿¡æ¯å˜é‡

| æ¨¡æ¿ä¸­çš„é”™è¯¯å†™æ³• | æ­£ç¡®å†™æ³• |
|-----------------|---------|
| `{{ Contacto1 }}` | `{{ contacto1 }}` |
| `{{ Contacto2 }}` | `{{ contacto2 }}` |
| `{{ Contacto3 }}` | `{{ contacto3 }}` |
| `{{ Cargo_contacto1 }}` | `{{ cargo_contacto1 }}` |
| `{{ Cargo_contacto2 }}` | `{{ cargo_contacto2 }}` |
| `{{ Cargo_contacto3 }}` | `{{ cargo_contacto3 }}` |

**æ³¨æ„**: `correo_contacto1/2/3` å·²ç»æ˜¯æ­£ç¡®çš„å°å†™æ ¼å¼ âœ“

### 2.2 å…¨å±€å˜é‡

| æ¨¡æ¿ä¸­çš„é”™è¯¯å†™æ³• | æ­£ç¡®å†™æ³• |
|-----------------|---------|
| `{{ Entidad_cliente }}` | `{{ entidad_cliente }}` |
| `{{ DescripciÃ³n_actividad }}` | `{{ descripcion_actividad }}` |
| `{{ Texto_anexo3 }}` | `{{ texto_anexo3 }}` |

---

## ä¸‰ã€åŠ¨æ€è¡¨æ ¼å¾ªç¯å˜é‡å¼•ç”¨é”™è¯¯ (ä¸¥é‡é—®é¢˜)

### 3.1 SEC2_TABLE_03 - Tipo de OperaciÃ³n Vinculada

**å½“å‰é”™è¯¯ç»“æ„**:
```jinja2
{% for servicio in servicios_vinculados %}
{% for entidad in servicio.entidades_vinculadas %}
{{ servicio_vinculado }}      â† âŒ é”™è¯¯ï¼
{{ entidad_vinculada }}       â† âŒ é”™è¯¯ï¼
{{ ingreso_entidad }}         â† âŒ é”™è¯¯ï¼
{% endfor %}
{% endfor %}
```

**é—®é¢˜è¯´æ˜**:
- åœ¨å¾ªç¯å†…éƒ¨ï¼Œå¿…é¡»é€šè¿‡å¾ªç¯å˜é‡è®¿é—®å±æ€§
- `servicio_vinculado` éœ€è¦æ”¹ä¸º `servicio.servicio_vinculado`
- `entidad_vinculada` éœ€è¦æ”¹ä¸º `entidad.entidad_vinculada`
- `ingreso_entidad` éœ€è¦æ”¹ä¸º `entidad.ingreso_entidad`

**æ­£ç¡®ç»“æ„**:
```jinja2
{% for servicio in servicios_vinculados %}
{% for entidad in servicio.entidades_vinculadas %}
{{ servicio.servicio_vinculado }}
{{ entidad.entidad_vinculada }}
{{ entidad.ingreso_entidad }}
{{ entidad.gasto_entidad }}
{% endfor %}
{% endfor %}
```

### 3.2 æ•°æ®ç»“æ„å‚è€ƒ

`servicios_vinculados` çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š
```python
servicios_vinculados = [
    {
        "servicio_vinculado": "Servicios de gestiÃ³n",
        "entidades_vinculadas": [
            {
                "entidad_vinculada": "Empresa A",
                "ingreso_entidad": 100000,
                "gasto_entidad": 50000
            },
            {
                "entidad_vinculada": "Empresa B",
                "ingreso_entidad": 200000,
                "gasto_entidad": 80000
            }
        ]
    }
]
```

---

## å››ã€ç¼ºå¤±å˜é‡

### 4.1 `gasto_entidad` å®Œå…¨ç¼ºå¤±

**é—®é¢˜**: åœ¨ SEC2_TABLE_03 å…³è”äº¤æ˜“è¡¨æ ¼ä¸­ï¼Œåªæœ‰ `ingreso_entidad` (æ”¶å…¥)ï¼Œç¼ºå°‘ `gasto_entidad` (æ”¯å‡º)

**éœ€è¦æ·»åŠ **:
```jinja2
{{ entidad.gasto_entidad }}
```

### 4.2 `impacto_2` ç¼ºå¤±

**é—®é¢˜**: é£é™©è¯„ä¼°è¡¨æ ¼ (ANEXO1_TABLE_07) ç¬¬2è¡Œç¼ºå°‘ `impacto_2` å˜é‡

**å½“å‰çŠ¶æ€**:
- `impacto_1` âœ“ å­˜åœ¨
- `impacto_2` âŒ ç¼ºå¤±
- `impacto_3` ~ `impacto_12` âœ“ å­˜åœ¨

**éœ€è¦æ·»åŠ **:
```jinja2
{{ impacto_2 }}
```

---

## äº”ã€å·²ä¿®å¤çš„å˜é‡ (æ— éœ€å†æ”¹)

ä»¥ä¸‹å˜é‡åœ¨ä¹‹å‰çš„ä¿®å¤ä¸­å·²ç»æ­£ç¡®ï¼š

### è´¢åŠ¡æ•°æ®å˜é‡ (å…¨éƒ¨å°å†™) âœ“
- `{{ cifra_1 }}`, `{{ cifra_0 }}`
- `{{ ebit_1 }}`, `{{ ebit_0 }}`
- `{{ cost_1 }}`, `{{ cost_0 }}`
- `{{ resultado_fin_1 }}`, `{{ resultado_fin_0 }}`
- `{{ ebt_1 }}`, `{{ ebt_0 }}`
- `{{ resultado_net_1 }}`, `{{ resultado_net_0 }}`
- `{{ om_1 }}`, `{{ om_0 }}`
- `{{ ncp_1 }}`, `{{ ncp_0 }}`

### å˜åŠ¨ç‡å˜é‡ âœ“
- `{{ var_cifra }}`, `{{ var_cost }}`, `{{ var_ebit }}`
- `{{ var_resfin }}`, `{{ var_ebt }}`, `{{ var_resnet }}`
- `{{ var_om }}`, `{{ var_ncp }}`

### å…³è”äº¤æ˜“æ±‡æ€» âœ“
- `{{ total_ingreso_oov }}`, `{{ total_gasto_oov }}`
- `{{ peso_oov_sobre_incn }}`, `{{ peso_oov_sobre_costes }}`

### åˆè§„è¡¨æ ¼å˜é‡ âœ“
- `{{ cumplido_local_1 }}` ~ `{{ cumplido_local_14 }}`
- `{{ texto_cumplido_local_1 }}` ~ `{{ texto_cumplido_local_14 }}`
- `{{ cumplido_mast_1 }}` ~ `{{ cumplido_mast_17 }}`
- `{{ texto_cumplido_mast_1 }}` ~ `{{ texto_cumplido_mast_17 }}`

### é£é™©è¡¨æ ¼å˜é‡ (é™¤ impacto_2 å¤–) âœ“
- `{{ impacto_1 }}`, `{{ impacto_3 }}` ~ `{{ impacto_12 }}`
- `{{ afectacion_pre_1 }}` ~ `{{ afectacion_pre_12 }}`
- `{{ texto_mitigacion_1 }}` ~ `{{ texto_mitigacion_12 }}`
- `{{ afectacion_final_1 }}` ~ `{{ afectacion_final_12 }}`

### æœåŠ¡åˆ†æå¾ªç¯ (servicios_oovv) âœ“
- `{{ servicio.texto_intro_servicio }}`
- `{{ servicio.descripcion_tabla }}`
- `{{ servicio.metodo }}`
- `{{ servicio.min }}`, `{{ servicio.lq }}`, `{{ servicio.med }}`
- `{{ servicio.uq }}`, `{{ servicio.max }}`
- `{{ servicio.texto_conclusion_servicio }}`

---

## å…­ã€å®Œæ•´ä¿®å¤æ¸…å•

### æ‰¹é‡æ›¿æ¢æ“ä½œ (æŒ‰ä¼˜å…ˆçº§æ’åº)

| # | æŸ¥æ‰¾ | æ›¿æ¢ä¸º | æ¬¡æ•° |
|---|------|--------|------|
| 1 | `anyo_ejecicio` | `anyo_ejercicio` | 15 |
| 2 | `Entidad_cliente` | `entidad_cliente` | 2 |
| 3 | `Contacto1` | `contacto1` | 1 |
| 4 | `Contacto2` | `contacto2` | 1 |
| 5 | `Contacto3` | `contacto3` | 1 |
| 6 | `Cargo_contacto1` | `cargo_contacto1` | 1 |
| 7 | `Cargo_contacto2` | `cargo_contacto2` | 1 |
| 8 | `Cargo_contacto3` | `cargo_contacto3` | 1 |
| 9 | `DescripciÃ³n_actividad` | `descripcion_actividad` | 1 |
| 10 | `Texto_anexo3` | `texto_anexo3` | 1 |

### æ‰‹åŠ¨ä¿®å¤æ“ä½œ

1. **SEC2_TABLE_03 å¾ªç¯å˜é‡ä¿®å¤**:
   - æ‰¾åˆ° `{% for servicio in servicios_vinculados %}` åŒºåŸŸ
   - å°† `{{ servicio_vinculado }}` æ”¹ä¸º `{{ servicio.servicio_vinculado }}`
   - å°† `{{ entidad_vinculada }}` æ”¹ä¸º `{{ entidad.entidad_vinculada }}`
   - å°† `{{ ingreso_entidad }}` æ”¹ä¸º `{{ entidad.ingreso_entidad }}`
   - æ·»åŠ  `{{ entidad.gasto_entidad }}` åˆ°æ”¯å‡ºåˆ—

2. **æ·»åŠ ç¼ºå¤±çš„ impacto_2**:
   - åœ¨é£é™©è¡¨æ ¼ç¬¬2è¡Œæ·»åŠ  `{{ impacto_2 }}`

---

## ä¸ƒã€ä¿®å¤è„šæœ¬ (Python)

```python
from docx import Document
import re

def fix_template(input_path, output_path):
    """ä¿®å¤æ¨¡æ¿å˜é‡"""
    doc = Document(input_path)

    # æ›¿æ¢è§„åˆ™
    replacements = {
        'anyo_ejecicio_ant': 'anyo_ejercicio_ant',  # å…ˆæ›¿æ¢é•¿çš„
        'anyo_ejecicio': 'anyo_ejercicio',
        'Entidad_cliente': 'entidad_cliente',
        'Contacto1': 'contacto1',
        'Contacto2': 'contacto2',
        'Contacto3': 'contacto3',
        'Cargo_contacto1': 'cargo_contacto1',
        'Cargo_contacto2': 'cargo_contacto2',
        'Cargo_contacto3': 'cargo_contacto3',
        'DescripciÃ³n_actividad': 'descripcion_actividad',
        'Texto_anexo3': 'texto_anexo3',
        # å¾ªç¯å˜é‡ä¿®å¤
        '{{ servicio_vinculado }}': '{{ servicio.servicio_vinculado }}',
        '{{ entidad_vinculada }}': '{{ entidad.entidad_vinculada }}',
        '{{ ingreso_entidad }}': '{{ entidad.ingreso_entidad }}',
    }

    def replace_in_runs(paragraph):
        """æ›¿æ¢æ®µè½ä¸­çš„æ–‡æœ¬"""
        full_text = ''.join(run.text for run in paragraph.runs)
        modified = full_text
        for old, new in replacements.items():
            modified = modified.replace(old, new)
        if modified != full_text:
            # æ¸…ç©ºæ‰€æœ‰runså¹¶åœ¨ç¬¬ä¸€ä¸ªrunä¸­è®¾ç½®æ–°æ–‡æœ¬
            for i, run in enumerate(paragraph.runs):
                if i == 0:
                    run.text = modified
                else:
                    run.text = ''

    # å¤„ç†æ®µè½
    for para in doc.paragraphs:
        replace_in_runs(para)

    # å¤„ç†è¡¨æ ¼
    for table in doc.tables:
        for row in table.rows:
            for cell in row.cells:
                for para in cell.paragraphs:
                    replace_in_runs(para)

    doc.save(output_path)
    print(f"å·²ä¿å­˜ä¿®å¤åçš„æ¨¡æ¿: {output_path}")

# ä½¿ç”¨æ–¹æ³•
# fix_template('config/template_final.docx', 'config/template_final_fixed.docx')
```

---

## å…«ã€éªŒè¯æ£€æŸ¥

ä¿®å¤åï¼Œè¯·è¿è¡Œä»¥ä¸‹æ£€æŸ¥ç¡®ä¿æ‰€æœ‰å˜é‡æ­£ç¡®ï¼š

```bash
# éªŒè¯è„šæœ¬
python3 -c "
from docx import Document
doc = Document('config/template_final.docx')
errors = []
error_patterns = [
    'anyo_ejecicio', 'Contacto1', 'Contacto2', 'Contacto3',
    'Cargo_contacto', 'Entidad_cliente', 'DescripciÃ³n_actividad',
    'Texto_anexo3', '{{ servicio_vinculado }}', '{{ entidad_vinculada }}',
    '{{ ingreso_entidad }}'
]

for table in doc.tables:
    for row in table.rows:
        for cell in row.cells:
            text = cell.text
            for pattern in error_patterns:
                if pattern in text:
                    errors.append(f'å‘ç°é”™è¯¯: {pattern}')

for para in doc.paragraphs:
    for pattern in error_patterns:
        if pattern in para.text:
            errors.append(f'å‘ç°é”™è¯¯: {pattern}')

if errors:
    print('\\n'.join(errors))
else:
    print('âœ“ æ‰€æœ‰æ£€æŸ¥é€šè¿‡')
"
```

---

## ä¹ã€é‡è¦æç¤º

1. **ä¿®æ”¹å‰å¤‡ä»½**: åœ¨ä¿®æ”¹ `template_final.docx` å‰ï¼Œè¯·å…ˆåˆ›å»ºå¤‡ä»½
2. **å…¨å°å†™è§„åˆ™**: æ‰€æœ‰å˜é‡åå¿…é¡»ä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿
3. **å¾ªç¯å˜é‡å‰ç¼€**: åœ¨ for å¾ªç¯å†…éƒ¨è®¿é—®å±æ€§æ—¶ï¼Œå¿…é¡»ä½¿ç”¨å¾ªç¯å˜é‡ä½œä¸ºå‰ç¼€
4. **æµ‹è¯•éªŒè¯**: ä¿®æ”¹åè¯·ä½¿ç”¨å®é™…æ•°æ®æµ‹è¯•æ–‡æ¡£ç”Ÿæˆ

---

*æœ€åæ›´æ–°: 2026-01-02*
