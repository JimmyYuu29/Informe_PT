# Wordæ¨¡æ¿å¾…ä¿®æ”¹é¡¹ç›®

**åˆ†ææ—¥æœŸ**: 2026-01-02
**æ¨¡æ¿æ–‡ä»¶**: `config/template_final.docx`
**çŠ¶æ€**: å¾…ä¿®æ”¹

---

## é—®é¢˜æ¦‚è¿°

ç»è¿‡è¯¦ç»†åˆ†æ `template_final.docx` æ¨¡æ¿æ–‡ä»¶ï¼Œå‘ç°ä»¥ä¸‹ä»éœ€ä¿®æ”¹çš„é—®é¢˜ï¼š

| é—®é¢˜ç±»å‹ | æ•°é‡ | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ |
|---------|------|---------|------|
| å˜é‡æ ¼å¼é—®é¢˜ï¼ˆæ— ç©ºæ ¼ï¼‰ | 4å¤„ | ğŸ”´ ä¸¥é‡ | å¾…ä¿®å¤ |
| å˜é‡æ ¼å¼é—®é¢˜ï¼ˆåŒç©ºæ ¼ï¼‰ | 4å¤„ | ğŸ”´ ä¸¥é‡ | å¾…ä¿®å¤ |
| ç¼ºå¤±åˆ— | 1å¤„ | ğŸ”´ ä¸¥é‡ | å¾…ä¿®å¤ |

---

## ä¸€ã€å˜é‡æ ¼å¼é—®é¢˜ - æ— ç©ºæ ¼ (4å¤„)

docxtpl è¦æ±‚å˜é‡ä½¿ç”¨ `{{ variable }}` æ ¼å¼ï¼ˆä¸¤è¾¹éƒ½æœ‰ç©ºæ ¼ï¼‰ã€‚ä»¥ä¸‹å˜é‡ç¼ºå°‘ç©ºæ ¼ï¼š

### 1.1 æ®µè½ä¸­çš„é—®é¢˜

| ä½ç½® | é”™è¯¯å†™æ³• | æ­£ç¡®å†™æ³• |
|------|---------|---------|
| æ®µè½ 36 | `{{anyo_ejercicio}}` | `{{ anyo_ejercicio }}` |
| æ®µè½ 37 | `{{anyo_ejercicio}}` | `{{ anyo_ejercicio }}` |

**å®šä½æ–¹æ³•**: æœç´¢æ–‡æœ¬ "En la medida en que la DocumentaciÃ³n Facilitada" å’Œ "Debido a que la CompaÃ±Ã­a"

### 1.2 è¡¨æ ¼ä¸­çš„é—®é¢˜

| ä½ç½® | é”™è¯¯å†™æ³• | æ­£ç¡®å†™æ³• |
|------|---------|---------|
| è¡¨æ ¼6ï¼ˆé£é™©è¡¨æ ¼ï¼‰è¡¨å¤´ç¬¬3åˆ— | `{{anyo_ejercicio}}` | `{{ anyo_ejercicio }}` |
| è¡¨æ ¼6ï¼ˆé£é™©è¡¨æ ¼ï¼‰R1ç¬¬4åˆ— | `{{afectacion_pre_1 }}` | `{{ afectacion_pre_1 }}` |

**å®šä½æ–¹æ³•**:
- è¡¨æ ¼6 æ˜¯ "Elementos de riesgo en materia fiscal" è¡¨æ ¼
- è¡¨å¤´åŒ…å« "Impacto en CompaÃ±Ã­a Ejercicio"

---

## äºŒã€å˜é‡æ ¼å¼é—®é¢˜ - åŒç©ºæ ¼ (4å¤„)

ä»¥ä¸‹å˜é‡å·¦è¾¹æœ‰ä¸¤ä¸ªç©ºæ ¼ï¼Œåº”æ”¹ä¸ºå•ç©ºæ ¼ï¼š

### 2.1 æ®µè½ä¸­çš„é—®é¢˜

| ä½ç½® | é”™è¯¯å†™æ³• | æ­£ç¡®å†™æ³• |
|------|---------|---------|
| æ®µè½ 64 (æœåŠ¡æ ‡é¢˜) | `{{  servicio.titulo_servicio_oovv }}` | `{{ servicio.titulo_servicio_oovv }}` |

**å®šä½æ–¹æ³•**: ä½äº `{% if servicio.enabled %}` æ¡ä»¶å—å†…çš„æ ‡é¢˜

### 2.2 è¡¨æ ¼2 (å…³è”äº¤æ˜“è¡¨) ä¸­çš„é—®é¢˜

| å•å…ƒæ ¼ä½ç½® | é”™è¯¯å†™æ³• | æ­£ç¡®å†™æ³• |
|-----------|---------|---------|
| R2C0 (ç¬¬ä¸€åˆ—) | `{{  servicio.servicio_vinculado }}` | `{{ servicio.servicio_vinculado }}` |
| R2C1 (ç¬¬äºŒåˆ—) | `{{  entidad.entidad_vinculada }}` | `{{ entidad.entidad_vinculada }}` |
| R2C2 (ç¬¬ä¸‰åˆ—) | `{{  entidad.ingreso_entidad }}` | `{{ entidad.ingreso_entidad }}` |

**å®šä½æ–¹æ³•**:
- è¡¨æ ¼2 æ˜¯ "Tipo de operaciÃ³n vinculada" è¡¨æ ¼ï¼ˆ3åˆ—ï¼‰
- ä½äº `{%tr for servicio in servicios_vinculados %}` å¾ªç¯å†…

---

## ä¸‰ã€ç¼ºå¤±çš„ Gasto åˆ— (ä¸¥é‡)

### 3.1 é—®é¢˜æè¿°

è¡¨æ ¼2ï¼ˆå…³è”äº¤æ˜“è¡¨ï¼‰å½“å‰åªæœ‰ **3 åˆ—**ï¼š
1. Tipo de operaciÃ³n vinculada
2. Entidad vinculada
3. Ingreso FY {{ anyo_ejercicio }}

æ ¹æ® `normalized_template.txt` çš„è§„èŒƒï¼Œåº”è¯¥æœ‰ **4 åˆ—**ï¼Œç¼ºå°‘ï¼š
- **Gasto FY {{ anyo_ejercicio }}** åˆ—

### 3.2 ä¿®æ”¹æ–¹æ¡ˆ

**å½“å‰è¡¨æ ¼ç»“æ„ (3åˆ—)**:
```
| Tipo de operaciÃ³n vinculada | Entidad vinculada | Ingreso FY {{ anyo_ejercicio }} |
```

**ç›®æ ‡è¡¨æ ¼ç»“æ„ (4åˆ—)**:
```
| Tipo de operaciÃ³n vinculada | Entidad vinculada | Ingreso FY {{ anyo_ejercicio }} | Gasto FY {{ anyo_ejercicio }} |
```

**éœ€è¦æ·»åŠ çš„å†…å®¹**:
1. åœ¨è¡¨å¤´è¡Œæ·»åŠ ç¬¬4åˆ—: `Gasto FY {{ anyo_ejercicio }}`
2. åœ¨æ•°æ®è¡Œæ·»åŠ ç¬¬4åˆ—: `{{ entidad.gasto_entidad }}`
3. è°ƒæ•´æ±‡æ€»è¡Œçš„ä½ç½®

### 3.3 è¡¨æ ¼å®Œæ•´ä¿®æ”¹å‚è€ƒ

```
+--------------------------------+----------------------+--------------------------------+-------------------------------+
| Tipo de operaciÃ³n vinculada    | Entidad vinculada    | Ingreso FY {{ anyo_ejercicio }}| Gasto FY {{ anyo_ejercicio }} |
+--------------------------------+----------------------+--------------------------------+-------------------------------+
{%tr for servicio in servicios_vinculados %}
{%tr for entidad in servicio.entidades_vinculadas %}
| {{ servicio.servicio_vinculado }} | {{ entidad.entidad_vinculada }} | {{ entidad.ingreso_entidad }} | {{ entidad.gasto_entidad }} |
{%tr endfor %}
{%tr endfor %}
+--------------------------------+----------------------+--------------------------------+-------------------------------+
| Total ingreso oovv             |                      | {{ total_ingreso_oov }}        |                               |
| Total gasto oovv               |                      |                                | {{ total_gasto_oov }}         |
| Peso oovv sobre INCN           |                      | {{ peso_oov_sobre_incn }} %    |                               |
| Peso oovv sobre total costes   |                      |                                | {{ peso_oov_sobre_costes }} % |
+--------------------------------+----------------------+--------------------------------+-------------------------------+
```

---

## å››ã€ä¿®å¤ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | é—®é¢˜ | å½±å“ |
|-------|------|-----|
| P0 (æœ€é«˜) | æ·»åŠ  Gasto åˆ— | æ•°æ®æ— æ³•å®Œæ•´æ˜¾ç¤º |
| P1 | ä¿®å¤æ— ç©ºæ ¼å˜é‡ | å˜é‡å¯èƒ½æ— æ³•æ­£ç¡®æ¸²æŸ“ |
| P1 | ä¿®å¤åŒç©ºæ ¼å˜é‡ | å˜é‡å¯èƒ½æ— æ³•æ­£ç¡®æ¸²æŸ“ |

---

## äº”ã€å¿«é€Ÿä¿®å¤æ¸…å•

### 5.1 æŸ¥æ‰¾æ›¿æ¢æ“ä½œ

è¯·åœ¨ Word ä¸­ä½¿ç”¨æŸ¥æ‰¾æ›¿æ¢åŠŸèƒ½ï¼ˆæ³¨æ„ï¼šWord å¯èƒ½ä¼šåˆ†å‰²å˜é‡åˆ°å¤šä¸ª runsï¼Œå»ºè®®æ‰‹åŠ¨æ£€æŸ¥ï¼‰ï¼š

| # | æŸ¥æ‰¾ | æ›¿æ¢ä¸º | å¤‡æ³¨ |
|---|------|--------|------|
| 1 | `{{anyo_ejercicio}}` | `{{ anyo_ejercicio }}` | 4å¤„ |
| 2 | `{{afectacion_pre_1 }}` | `{{ afectacion_pre_1 }}` | 1å¤„ |
| 3 | `{{  servicio.titulo_servicio_oovv }}` | `{{ servicio.titulo_servicio_oovv }}` | 1å¤„ |
| 4 | `{{  servicio.servicio_vinculado }}` | `{{ servicio.servicio_vinculado }}` | 1å¤„ |
| 5 | `{{  entidad.entidad_vinculada }}` | `{{ entidad.entidad_vinculada }}` | 1å¤„ |
| 6 | `{{  entidad.ingreso_entidad }}` | `{{ entidad.ingreso_entidad }}` | 1å¤„ |

### 5.2 æ‰‹åŠ¨æ“ä½œ

1. **æ·»åŠ  Gasto åˆ—åˆ°è¡¨æ ¼2**ï¼š
   - åœ¨è¡¨æ ¼2ä¸­é€‰æ‹©æœ€åä¸€åˆ—
   - å³é”® â†’ åœ¨å³ä¾§æ’å…¥åˆ—
   - è¡¨å¤´å¡«å…¥: `Gasto FY {{ anyo_ejercicio }}`
   - æ•°æ®è¡Œå¡«å…¥: `{{ entidad.gasto_entidad }}`
   - è°ƒæ•´æ±‡æ€»è¡Œ

---

## å…­ã€éªŒè¯è„šæœ¬

ä¿®å¤åï¼Œè¿è¡Œä»¥ä¸‹ Python è„šæœ¬éªŒè¯ï¼š

```python
from docx import Document
import re

doc = Document('config/template_final.docx')

errors = []
warnings = []

# æ£€æŸ¥é¡¹
checks = [
    (r'\{\{[^ ]', 'å·¦è¾¹ç¼ºå°‘ç©ºæ ¼'),
    (r'[^ ]\}\}', 'å³è¾¹ç¼ºå°‘ç©ºæ ¼'),
    (r'\{\{  ', 'åŒç©ºæ ¼é—®é¢˜'),
]

for para in doc.paragraphs:
    text = ''.join(run.text for run in para.runs)
    for pattern, msg in checks:
        if re.search(pattern, text):
            errors.append(f'{msg}: {text[:50]}...')

for table in doc.tables:
    for row in table.rows:
        for cell in row.cells:
            text = ''.join(p.text for p in cell.paragraphs)
            for pattern, msg in checks:
                if re.search(pattern, text):
                    errors.append(f'{msg}: {text[:50]}...')

# æ£€æŸ¥ gasto_entidad
gasto_found = False
for table in doc.tables:
    for row in table.rows:
        for cell in row.cells:
            if 'gasto_entidad' in cell.text:
                gasto_found = True

if not gasto_found:
    errors.append('ç¼ºå°‘ gasto_entidad å˜é‡')

if errors:
    print('å‘ç°é—®é¢˜:')
    for e in set(errors):
        print(f'  - {e}')
else:
    print('âœ“ æ‰€æœ‰æ£€æŸ¥é€šè¿‡')
```

---

## ä¸ƒã€å·²ä¿®å¤çš„é—®é¢˜ï¼ˆå†å²è®°å½•ï¼‰

ä»¥ä¸‹é—®é¢˜å·²åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ä¿®å¤ï¼Œæ— éœ€å†æ¬¡å¤„ç†ï¼š

- âœ… `anyo_ejecicio` æ‹¼å†™é”™è¯¯ â†’ `anyo_ejercicio`
- âœ… å¤§å°å†™å˜é‡å (Contacto1, Entidad_cliente ç­‰) â†’ å°å†™
- âœ… `DescripciÃ³n_actividad` â†’ `descripcion_actividad`
- âœ… `Texto_anexo3` â†’ `texto_anexo3`
- âœ… å¾ªç¯å˜é‡ä½¿ç”¨ `{%tr %}` è¯­æ³•
- âœ… `tabla_num.next()` è¡¨æ ¼ç¼–å·åŠŸèƒ½
- âœ… æ¡ä»¶å— `{% if master_file == 1 %}` è¯­æ³•
- âœ… impacto_1 åˆ° impacto_12 å˜é‡å·²æ·»åŠ 

---

*æœ€åæ›´æ–°: 2026-01-02*
