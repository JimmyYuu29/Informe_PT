# Word模板修改方案

## 问题概述

经过分析，模板中的变量占位符存在以下问题导致数据无法正确显示：

1. **变量名大小写不匹配** - docxtpl (Jinja2) 是大小写敏感的
2. **循环语法错误** - for循环中的对象属性访问语法不正确
3. **变量引用方式错误** - 在循环内部没有正确引用循环变量

---

## 详细修改说明

### 1. Datos Financieros 表格 (SEC2_TABLE_02)

#### 问题
模板中的变量名使用了不正确的大小写：

| 模板中的错误写法 | 正确写法 |
|-----------------|---------|
| `{{ Var_cifra }}` | `{{ var_cifra }}` |
| `{{ Var_cost }}` | `{{ var_cost }}` |
| `{{ Var_EBIT }}` | `{{ var_ebit }}` |
| `{{ Var_ResFin }}` | `{{ var_resfin }}` |
| `{{ Var_EBT }}` | `{{ var_ebt }}` |
| `{{ Var_ResNet }}` | `{{ var_resnet }}` |
| `{{ Var_OM }}` | `{{ var_om }}` |
| `{{ Var_NCP }}` | `{{ var_ncp }}` |
| `{{ Cost_1 }}` | `{{ cost_1 }}` |
| `{{ Cost_0 }}` | `{{ cost_0 }}` |
| `{{ EBIT_1 }}` | `{{ ebit_1 }}` |
| `{{ EBIT_0 }}` | `{{ ebit_0 }}` |
| `{{ EBT_1 }}` | `{{ ebt_1 }}` |
| `{{ EBT_0 }}` | `{{ ebt_0 }}` |
| `{{ OM_1 }}` | `{{ om_1 }}` |
| `{{ OM_0 }}` | `{{ om_0 }}` |
| `{{ NCP_1 }}` | `{{ ncp_1 }}` |
| `{{ NCP_0 }}` | `{{ ncp_0 }}` |
| `{{ Resultado_fin_1 }}` | `{{ resultado_fin_1 }}` |
| `{{ Resultado_fin_0 }}` | `{{ resultado_fin_0 }}` |
| `{{ Resultado_net_1 }}` | `{{ resultado_net_1 }}` |
| `{{ Resultado_net_0 }}` | `{{ resultado_net_0 }}` |

#### 正确的变量列表（财务数据）

**输入字段（小写）:**
- `{{ cifra_1 }}` - 当年营业收入
- `{{ cifra_0 }}` - 上年营业收入
- `{{ ebit_1 }}` - 当年EBIT
- `{{ ebit_0 }}` - 上年EBIT
- `{{ resultado_fin_1 }}` - 当年财务结果
- `{{ resultado_fin_0 }}` - 上年财务结果
- `{{ ebt_1 }}` - 当年EBT
- `{{ ebt_0 }}` - 上年EBT
- `{{ resultado_net_1 }}` - 当年净利润
- `{{ resultado_net_0 }}` - 上年净利润

**派生字段（全部小写）:**
- `{{ cost_1 }}` - 当年总成本 (cifra_1 - ebit_1)
- `{{ cost_0 }}` - 上年总成本 (cifra_0 - ebit_0)
- `{{ om_1 }}` - 当年营业利润率 %
- `{{ om_0 }}` - 上年营业利润率 %
- `{{ ncp_1 }}` - 当年净成本加成 %
- `{{ ncp_0 }}` - 上年净成本加成 %
- `{{ var_cifra }}` - 营业收入变动率 %
- `{{ var_cost }}` - 成本变动率 %
- `{{ var_ebit }}` - EBIT变动率 %
- `{{ var_resfin }}` - 财务结果变动率 %
- `{{ var_ebt }}` - EBT变动率 %
- `{{ var_resnet }}` - 净利润变动率 %
- `{{ var_om }}` - 营业利润率变动（百分点）
- `{{ var_ncp }}` - 净成本加成变动（百分点）

**年份变量:**
- `{{ anyo_ejercicio }}` - 当前财年
- `{{ anyo_ejercicio_ant }}` - 上一财年

---

### 2. Tipo de Operación Vinculada 表格 (SEC2_TABLE_03)

#### 问题
循环语法和变量引用错误：

**错误写法:**
```jinja2
{% for servicio in servicios_vinculados %}
{% for entidad in servicio entidades_vinculadas %}  <- 缺少点号！
{{ servicio_vinculado }}  <- 需要引用循环变量
{{ entidad_vinculada }}
{{ ingreso_entidad }}
{% endfor %}
{% endfor %}
```

**正确写法:**
```jinja2
{% for servicio in servicios_vinculados %}
{% for entidad in servicio.entidades_vinculadas %}
{{ servicio.servicio_vinculado }}
{{ entidad.entidad_vinculada }}
{{ entidad.ingreso_entidad }}
{{ entidad.gasto_entidad }}
{% endfor %}
{% endfor %}
```

#### 完整的正确模板结构

```jinja2
{% for servicio in servicios_vinculados %}
{% for entidad in servicio.entidades_vinculadas %}
| {{ servicio.servicio_vinculado }} | {{ entidad.entidad_vinculada }} | {{ entidad.ingreso_entidad }} |
{% endfor %}
{% endfor %}
```

**可用的变量:**
- `{{ total_ingreso_oov }}` - 关联收入总计
- `{{ total_gasto_oov }}` - 关联支出总计
- `{{ peso_oov_sobre_incn }}` - 关联收入占营业收入比例 %
- `{{ peso_oov_sobre_costes }}` - 关联支出占成本比例 %

---

### 3. Tabla 9 - 风险评估表格 (ANEXO1_TABLE_07)

#### 问题
变量名大小写不正确：

| 模板中的错误写法 | 正确写法 |
|-----------------|---------|
| `{{ Impacto_1 }}` | `{{ impacto_1 }}` |
| `{{ Afectacion_Pre_1 }}` | `{{ afectacion_pre_1 }}` |
| `{{ Afectacion_final_1 }}` | `{{ afectacion_final_1 }}` |
| ... (对于所有12行) | ... |

#### 正确的变量格式（风险表格第1-12行）

对于每一行 `i` (1-12)：
- `{{ impacto_i }}` - 影响 (si/no/posible)
- `{{ afectacion_pre_i }}` - 初步影响程度 (bajo/medio/alto)
- `{{ texto_mitigacion_i }}` - 缓解措施文本
- `{{ afectacion_final_i }}` - 最终影响程度 (bajo/medio/alto)

**示例（第1行）:**
```
{{ impacto_1 }}
{{ afectacion_pre_1 }}
{{ texto_mitigacion_1 }}
{{ afectacion_final_1 }}
```

---

### 4. Local File 合规表格 (ANEXO2_TABLE_08)

#### 正确的变量格式（第1-14行）

对于每一行 `i` (1-14)：
- `{{ cumplido_local_i }}` - 合规状态 (si/parcial/no)
- `{{ texto_cumplido_local_i }}` - 备注文本

**示例:**
```
{{ cumplido_local_1 }}
{{ texto_cumplido_local_1 }}
```

---

### 5. Master File 合规表格 (ANEXO2_TABLE_09)

#### 正确的变量格式（第1-17行）

对于每一行 `i` (1-17)：
- `{{ cumplido_mast_i }}` - 合规状态 (si/parcial/no)
- `{{ texto_cumplido_mast_i }}` - 备注文本

**示例:**
```
{{ cumplido_mast_1 }}
{{ texto_cumplido_mast_1 }}
```

---

### 6. 合规摘要表格 (SEC2_TABLE_05, SEC2_TABLE_06)

#### Local File 摘要
```
{{ cumplimiento_resumen_local_1 }}
{{ cumplimiento_resumen_local_2 }}
{{ cumplimiento_resumen_local_3 }}
```

#### Master File 摘要
```
{{ cumplimiento_resumen_mast_1 }}
{{ cumplimiento_resumen_mast_2 }}
{{ cumplimiento_resumen_mast_3 }}
{{ cumplimiento_resumen_mast_4 }}
```

---

## 修改步骤

### 方法一：直接在Word中查找替换

1. 打开 `config/template_final.docx`
2. 使用 **Ctrl+H** 打开查找替换对话框
3. 按照上述对照表逐一替换
4. 注意：确保勾选"区分大小写"选项

### 方法二：解压docx修改XML

1. 将 `.docx` 文件后缀改为 `.zip`
2. 解压缩
3. 编辑 `word/document.xml` 文件
4. 使用文本编辑器批量替换
5. 重新压缩并改回 `.docx` 后缀

### 方法三：使用Python脚本自动替换

```python
from docx import Document
import re

# 打开文档
doc = Document('config/template_final.docx')

# 定义替换规则
replacements = {
    'Var_cifra': 'var_cifra',
    'Var_cost': 'var_cost',
    'Var_EBIT': 'var_ebit',
    'EBIT_1': 'ebit_1',
    'EBIT_0': 'ebit_0',
    'Cost_1': 'cost_1',
    'Cost_0': 'cost_0',
    # ... 添加更多替换规则
}

# 替换段落中的文本
for para in doc.paragraphs:
    for old, new in replacements.items():
        if old in para.text:
            para.text = para.text.replace(old, new)

# 替换表格中的文本
for table in doc.tables:
    for row in table.rows:
        for cell in row.cells:
            for old, new in replacements.items():
                if old in cell.text:
                    for para in cell.paragraphs:
                        para.text = para.text.replace(old, new)

# 保存
doc.save('config/template_final_fixed.docx')
```

---

## 重要提示

1. **所有变量名必须小写** - 这是最重要的规则
2. **循环中访问对象属性必须使用点号** - `servicio.entidades_vinculadas` 而不是 `servicio entidades_vinculadas`
3. **循环内部引用变量要带循环变量前缀** - `entidad.ingreso_entidad` 而不是 `ingreso_entidad`
4. **修改前请备份原模板**

---

## 完整变量参考表

### 全局变量
| 变量名 | 描述 | 类型 |
|--------|------|------|
| `fecha_fin_fiscal` | 财年结束日期 | date |
| `fecha_fin_fiscal_formatted` | 格式化的财年结束日期 | string |
| `entidad_cliente` | 客户实体名称 | string |
| `master_file` | 是否有Master File (0/1) | enum |
| `descripcion_actividad` | 活动描述 | text |
| `anyo_ejercicio` | 当前财年 | int |
| `anyo_ejercicio_ant` | 上一财年 | int |

### 联系人变量
| 变量名 | 描述 |
|--------|------|
| `contacto1` / `contacto2` / `contacto3` | 联系人姓名 |
| `cargo_contacto1` / `cargo_contacto2` / `cargo_contacto3` | 联系人职位 |
| `correo_contacto1` / `correo_contacto2` / `correo_contacto3` | 联系人邮箱 |

如有其他问题，请参考 `config/yamls/pt_review/fields.yaml` 和 `config/yamls/pt_review/derived.yaml` 获取完整的变量列表。
