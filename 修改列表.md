# 模板修改列表

**创建日期**: 2026-01-02
**模板文件**: `config/template_final.docx`

---


## 1. documentacion_facilitada 列表格式修改

### 问题描述
当前使用以下模板语法:
```
{%- for doc in documentacion_facilitada -%}
•	{{ doc }}
{%- endfor -%}
```
会导致所有内容合并在一行中。

### 解决方案
将上述代码替换为:
```
{{ documentacion_facilitada_richtext }}
```

这将使用预格式化的 RichText 变量，自动生成带有 bullet points 的列表，每个项目在单独一行，不会有额外的空行。

---

## 2. fecha_fin_fiscal 日期格式

### 已完成的修改
`fecha_fin_fiscal` 现在自动输出为 `DD-Mmm-YYYY` 格式（例如：`31-Ene-2025`），其中月份使用西班牙语三字母缩写，首字母大写。

模板中使用 `{{ fecha_fin_fiscal }}` 将直接输出正确格式。

---

## 3. 条件渲染空行处理

### 问题描述
当 `{% if variable == 1 %}` 条件不满足时，模板中会保留空行。

### 解决方案
在模板中使用带有空白控制的语法:
```
{%- if master_file == 1 -%}
内容
{%- endif -%}
```
注意 `-%}` 和 `{%-` 的使用，它们会移除周围的空白。

对于需要完全删除的段落，使用段落级别的条件:
```
{%p if master_file == 1 %}
这整个段落在条件不满足时会被删除
{%p endif %}
```

---

## 4. servicios_oovv 分析板块

### 说明
每个 servicio vinculado 现在可以关联一个分析选项。在 UI 中为每个 servicio vinculado 启用"分析此服务"后，将在 servicios_oovv 列表中添加相应的分析板块。

模板中使用:
```
{% for servicio in servicios_oovv %}
{% if servicio.enabled %}
2.2.X	{{ servicio.titulo_servicio_oovv }}
{{ servicio.texto_intro_servicio }}
{{ servicio.descripcion_tabla }}
Tabla {{ tabla_num.next() }}
Método Elegido	Min	LQ	Med	UQ	Max
{{ servicio.metodo }}	{{ servicio.min }} %	{{ servicio.lq }} %	{{ servicio.med }} %	{{ servicio.uq }} %	{{ servicio.max }} %
{{ servicio.texto_conclusion_servicio }}
{% endif %}
{% endfor %}
```

---

## 5. JSON 导入/导出 修复

### 问题描述
- 导入 JSON 时，"Información General""Datos Financieros""Anexo III - Comentarios""Contactos"板块的字段在 UI 中未正确回填。
- "Clear Form" 无法完全清理已填写的字段/列表数据。
- 导出/导入过程中出现 `form_data` 未初始化的报错。
- 导入时出现 `TypeError: bad argument type for built-in operation` 错误（st.selectbox的index参数类型错误）。

### 解决方案
- **修复 TypeError**：`render_enum_input` 函数中增加了对整数/字符串值的规范化比较，确保 `default_index` 始终是有效的整数索引。
- **导入流程优化**：
  - 导入时先清除所有widget状态，然后设置form_data值
  - 使用 `_data_just_imported` 标志让组件优先从 form_data 读取值
  - 改进 `_coerce_widget_value` 函数以正确处理日期字符串和数值类型
- **导出流程**：按 UI 顺序构建有序 JSON（含列表字段顺序），键顺序与界面一致。
- **清空表单优化**：
  - 扩展 widget key 清理策略（前缀+包含匹配）
  - 增加更多字段名模式匹配（contacto, cargo_contacto, correo_contacto, texto_anexo, cifra_, ebit_, etc.）
  - 彻底移除残留状态

### 修改的文件
1. `ui/streamlit_app/components.py` - 修复 `render_enum_input` 函数的索引查找逻辑
2. `ui/streamlit_app/state_store.py` - 增强 `clear_form_data` 函数的清理范围
3. `ui/streamlit_app/app.py` - 改进 `_force_clear_widget_state`、`_coerce_widget_value` 和 `load_json_data` 函数

### 验证
- `python tests/test_json_import_export.py`（执行两次，全部通过）

---

*最后更新: 2026-01-04*
