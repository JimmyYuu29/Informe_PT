# 模板修改列表

**创建日期**: 2026-01-02
**模板文件**: `config/template_final.docx`

---


## 1. documentacion_facilitada 列表格式修改

### 问题描述
当前使用以下模板语法:
```
{%- for doc in documentacion_facilitada -%}
•	{{ doc }}
{%- endfor -%}
```
会导致所有内容合并在一行中。

### 解决方案
将上述代码替换为:
```
{{ documentacion_facilitada_richtext }}
```

这将使用预格式化的 RichText 变量，自动生成带有 bullet points 的列表，每个项目在单独一行，不会有额外的空行。

---

## 2. fecha_fin_fiscal 日期格式

### 已完成的修改
`fecha_fin_fiscal` 现在自动输出为 `DD-Mmm-YYYY` 格式（例如：`31-Ene-2025`），其中月份使用西班牙语三字母缩写，首字母大写。

模板中使用 `{{ fecha_fin_fiscal }}` 将直接输出正确格式。

---

## 3. 条件渲染空行处理

### 问题描述
当 `{% if variable == 1 %}` 条件不满足时，模板中会保留空行。

### 解决方案
在模板中使用带有空白控制的语法:
```
{%- if master_file == 1 -%}
内容
{%- endif -%}
```
注意 `-%}` 和 `{%-` 的使用，它们会移除周围的空白。

对于需要完全删除的段落，使用段落级别的条件:
```
{%p if master_file == 1 %}
这整个段落在条件不满足时会被删除
{%p endif %}
```

---

## 4. servicios_oovv 分析板块

### 说明
每个 servicio vinculado 现在可以关联一个分析选项。在 UI 中为每个 servicio vinculado 启用"分析此服务"后，将在 servicios_oovv 列表中添加相应的分析板块。

模板中使用:
```
{% for servicio in servicios_oovv %}
{% if servicio.enabled %}
2.2.X	{{ servicio.titulo_servicio_oovv }}
{{ servicio.texto_intro_servicio }}
{{ servicio.descripcion_tabla }}
Tabla {{ tabla_num.next() }}
Método Elegido	Min	LQ	Med	UQ	Max
{{ servicio.metodo }}	{{ servicio.min }} %	{{ servicio.lq }} %	{{ servicio.med }} %	{{ servicio.uq }} %	{{ servicio.max }} %
{{ servicio.texto_conclusion_servicio }}
{% endif %}
{% endfor %}
```

---

## 5. JSON 导入/导出 修复

### 问题描述
- 导入 JSON 时，“Información General”“Datos Financieros”“Anexo III - Comentarios”“Contactos”板块的字段在 UI 中未正确回填。
- “Clear Form” 无法完全清理已填写的字段/列表数据。
- 导出/导入过程中出现 `form_data` 未初始化的报错。

### 解决方案
- 导入流程同步写入 widget state，并对标量值做类型强制（如日期），确保界面即时呈现且不被缓存覆盖。
- 导出流程按 UI 顺序构建有序 JSON（含列表字段顺序），键顺序与界面一致。
- 清空表单时扩展 widget key 清理策略（前缀+包含匹配），彻底移除残留状态。
- 增加 session_state 基础键的兜底初始化，避免 `form_data` 缺失导致的异常。

### 验证
- `PYTHONIOENCODING=utf-8 ..\\venv\\Scripts\\python.exe tests/test_json_import_export.py`（执行两次，全部通过）

---

*最后更新: 2026-01-04*
